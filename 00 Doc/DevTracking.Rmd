---
title: "DV_RProject3: Tall Glass of Oil"
output: html_document
---

![](./Graphics/Oil.jpg) 

## 00. Create/Clone a github repository
Go to SourceTree software. Create new git repository in DataVisualization folder (on same level as DrCannata folder).
![](./Graphics/createrepo.png)

If did not create the repo, clone the repo in SourceTree software.
![](./Graphics/clonerepo.png)

## 01. Create RStudio Project
Create an RStudio project in the project folder.  
![](./Graphics/createproject01.png)

## 02. Setup RStudio 
 Create three folders in RStudio Project:  
   **00 Doc**: where .Rmd and graphics folder lives  
   **01 Data**: where data will be stored  
   **02 DataWrangling**: where data is explored in ggplot  
   **03 Visualizations**: Where visualizations are saved  
   
   
![](./Graphics/fileset.png)

## 03. Download .CSV Files

Download csv files for energy consumption, prices, expenditures, and data codes for energy consumption in the United States. All files downloaded as .xlxs were converted into .csv files.  

Downloaded from: http://www.eia.gov/tools/models/timeseries.cfm  

![](./Graphics/download.png)

## 04. ETL

```{R eval=FALSE}
require(tidyr)
require(dplyr)
require(ggplot2)

setwd("~/DataVisualization/DV_RProject3/CSVs/")

files <- list("ex_all", "MSNCodes", "pr_adjust_consum", "pr_all", "Prod_dataset", "use_all_btu", "use_all_phy")

# change index number for each file
file_path <- paste(files[0], '.csv', sep='')

df <- read.csv(file_path, stringsAsFactors = FALSE)


# Replace "." (i.e., period) with "_" in the column names.
names(df) <- gsub("\\.+", "_", names(df))

str(df) # Uncomment this and  run just the lines to here to get column types to use for getting the list of measures.



measures <- c()

#for (i in 1970:2013) #uncomment for prices and expenditures
#for (i in 1960:2013) #uncomment for production_data and usage

#  { measures <- c(measures, paste('x',toString(i), sep = '')) }

#measures <- NA # uncomment for MSN_Codes



# Get rid of special characters in each column.
# Google ASCII Table to understand the following:
for(n in names(df)) {
  df[n] <- data.frame(lapply(df[n], gsub, pattern="[^ -~]",replacement= ""))
}


dimensions <- setdiff(names(df), measures)
if( length(measures) > 1 || ! is.na(dimensions)) {
  for(d in dimensions) {
    # Get rid of " and ' in dimensions.
    df[d] <- data.frame(lapply(df[d], gsub, pattern="[\"']",replacement= ""))
    # Change & to and in dimensions.
    df[d] <- data.frame(lapply(df[d], gsub, pattern="&",replacement= " and "))
    # Change : to ; in dimensions.
    df[d] <- data.frame(lapply(df[d], gsub, pattern=":",replacement= ";"))
  }
}

library(lubridate)
# Fix date columns, this needs to be done by hand because | needs to be correct.
#                                                        \_/
df$Order_Date <- gsub(" [0-9]+:.*", "", gsub(" UTC", "", mdy(as.character(df$Order_Date), tz="UTC")))
df$Ship_Date  <- gsub(" [0-9]+:.*", "", gsub(" UTC", "", mdy(as.character(df$Ship_Date),  tz="UTC")))

# The following is an example of dealing with special cases like making state abbreviations be all upper case.
# df["State"] <- data.frame(lapply(df["State"], toupper))

# Get rid of all characters in measures except for numbers, the - sign, and period.dimensions
if( length(measures) > 1 || ! is.na(measures)) {
  for(m in measures) {
    df[m] <- data.frame(lapply(df[m], gsub, pattern="[^--.0-9]",replacement= ""))
  }
}

write.csv(df, paste(gsub(".csv", "", file_path), ".reformatted.csv", sep=""), row.names=FALSE, na = "")

tableName <- gsub(" +", "_", gsub("[^A-z, 0-9, ]", "", gsub(".csv", "", file_path)))
sql <- paste("CREATE TABLE", tableName, "(\n-- Change table_name to the table name you want.\n")
if( length(measures) > 1 || ! is.na(dimensions)) {
  for(d in dimensions) {
    sql <- paste(sql, paste(d, "varchar2(4000),\n"))
  }
}
if( length(measures) > 1 || ! is.na(measures)) {
  for(m in measures) {
    if(m != tail(measures, n=1)) sql <- paste(sql, paste(m, "number(38,4),\n"))
    else sql <- paste(sql, paste(m, "number(38,4)\n"))
  }
}
sql <- paste(sql, ");")
cat(sql)
```

## 05. Summary and Subset

Since we have 7 CSV files in total, we will only create one dataframe from one of the data tables on Oracle for demonstration: Energy Price of 50 states and D.C. OVer the Years.

### Summary of Dataframe

Creating dataframe from Oracle's database with SQL query:

```{r, warning = FALSE}
require("jsonlite")
require("RCurl")
dframe <- data.frame(fromJSON(getURL(URLencode('129.152.144.84:5001/rest/native/?query="select * from energy_prices"'),httpheader=c(DB='jdbc:oracle:thin:@129.152.144.84:1521/PDBF15DV.usuniversi01134.oraclecloud.internal', USER='cs329e_cjs2599', PASS='orcl_cjs2599', MODE='native_mode', MODEL='model', returnDimensions = 'False', returnFor = 'JSON'), verbose = TRUE), ))
```

```{r}
summary(dframe)
```  

### Subset of Dataframe

Energy Price at Texas, a subset of the Energy Price dataframe:

```{r, warning = FALSE}
head(subset(dframe, STATE == "TX"))
```

## 06. Visualizations

```{R, echo = FALSE, warning = FALSE}
require(dplyr)
require(tidyr)
require(ggplot2)
require(jsonlite)
require(RCurl)
require(stringr)

dfexpend <- data.frame(fromJSON(getURL(URLencode('129.152.144.84:5001/rest/native/?query="select * from ENERGY_EXPENDITURES;"'),httpheader=c(DB='jdbc:oracle:thin:@129.152.144.84:1521/PDBF15DV.usuniversi01134.oraclecloud.internal', USER='cs329e_cjs2599', PASS='orcl_cjs2599', MODE='native_mode', MODEL='model', returnDimensions = 'False', returnFor = 'JSON'), verbose = TRUE), ))

dfprice <- data.frame(fromJSON(getURL(URLencode('129.152.144.84:5001/rest/native/?query="select * from ENERGY_PRICES;"'),httpheader=c(DB='jdbc:oracle:thin:@129.152.144.84:1521/PDBF15DV.usuniversi01134.oraclecloud.internal', USER='cs329e_cjs2599', PASS='orcl_cjs2599', MODE='native_mode', MODEL='model', returnDimensions = 'False', returnFor = 'JSON'), verbose = TRUE), ))

MSN_ref <- data.frame(fromJSON(getURL(URLencode('129.152.144.84:5001/rest/native/?query="select * from ENERGY_MSN_LOOKUP;"'),httpheader=c(DB='jdbc:oracle:thin:@129.152.144.84:1521/PDBF15DV.usuniversi01134.oraclecloud.internal', USER='cs329e_cjs2599', PASS='orcl_cjs2599', MODE='native_mode', MODEL='model', returnDimensions = 'False', returnFor = 'JSON'), verbose = TRUE), ))

# Find general Energy Type labels from MSN reference table
MSN_ref %>% filter(UNIT != "Percent Share") %>% mutate(energy_label = word(DESCRIPTION,1)) %>% mutate(msn_short = substr(MSN, 0, 2)) %>% melt(id="energy_label") %>% rename(MSN = value) -> MSN_ref

# create unique row ids by concatenating State and MSN code
# pop last char of MSN, which codes for unit of measure, to obtain matching MSNs across expenditure and price
dfexpend %>% mutate(row_id = paste(STATE, '_', substr(MSN, 0, 4), sep='')) -> dfexpend
dfprice %>% mutate(row_id = paste(STATE, '_', substr(MSN, 0, 4), sep='')) -> dfprice

# melt data down so year is variable, not column name
newex <- dfexpend %>% select(-DATA_STATUS) %>% melt(., id=c('row_id','STATE','MSN')) %>% rename(year = variable) %>% rename(expenditure = value)
newpr <- dfprice %>% select(-DATA_STATUS) %>% melt(., id=c('row_id','STATE','MSN')) %>% rename(year = variable) %>% rename(price = value)

# append energy labels to newex
left_join(newex, MSN_ref, by=("MSN")) %>% select(-variable) -> newex

# join expenses and prices
dplyr::full_join(newex, newpr, by=c("row_id","year","STATE")) -> prex
prex %>% mutate(year = substr(year, 2, 5)) %>% mutate(energy_type = substr(MSN.x, 0, 3)) -> prex


prex %>% filter(STATE != "US") %>% filter(energy_label != "All") %>% filter(energy_label != "Total") %>% filter(energy_label != "Primary") %>% filter(price < 1000000) %>% filter(expenditure < 100000) %>% ggplot(aes(x=as.numeric(expenditure), y =as.numeric(price), color=as.numeric(year))) + geom_point() + facet_wrap(~energy_label) + labs(x="Expenditures", y="Price") + labs(title="Price to Expenditure Ratio By Energy Sector") + theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

- This graph shows broadly the relationship between cost to the producer and cost to the consumer of energy prices, and how this relationship differs across sectors.

- Electricity and Motor Fuel have far and away the most consistently high cost-to-price ratio, but in recent years natural gas, asphalt, distillate, and petrochemical have shown high ratios as well

- Lubricants, Aviation fuel, Kerosene, Waxes, and Wood show an astoundingly low cost-to-price ratio, indicating that profit margins are far higher than average for the companies that produce them (compared, at least, to other energy sectors)

- Interestingly, nuclear energy has had astoundingly low costs and prices since it (relatively recently) began being recorded. For the interest of both the consumer and the producer, this makes a compelling argument for the propagation or nuclear energy.


### The End
  
  
